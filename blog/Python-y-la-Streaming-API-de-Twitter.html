<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Enrique Marcos">
  <meta name="description" content="TL;DR - Developer">
  <link type="text/plain" rel="author" href="/humans.txt">
  <link rel="shortcut icon" href="/favicon.ico">
  
     <title>Python y la Streaming API de Twitter | Enrique Marcos</title>
  


  <script type="text/javascript">
    if (navigator.appVersion.indexOf("Win")!=-1) {
        document.write('<link rel="stylesheet" type="text/css" media="all" href="fonts/equity-a.css" />');
    } else if (navigator.appVersion.indexOf("Mac")!=-1) {
        if (navigator.userAgent.match(/iPad/i) != null) {
            document.write('<link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="/assets/fonts/equity-b.css" type="text/css" />');
            document.write('<link rel="stylesheet" media="only screen and (min-device-width: 768px) and (max-device-width: 1024px) and (-webkit-min-device-pixel-ratio: 2)" type="text/css" href="/assets/fonts/equity-a.css" />');
        } else {
            document.write('<link rel="stylesheet" type="text/css" media="all" href="/assets/fonts/equity-b.css" />');
        }
    } else {
        document.write('<link rel="stylesheet" type="text/css" media="all" href="/assets/fonts/equity-a.css" />');
    }
  </script>

  <link rel="stylesheet" type="text/css" media="all" href="/assets/fonts/equity-b.css">
  <link rel="stylesheet" type="text/css" media="all" href="/assets/css/styles.css">
  <link rel="stylesheet" type="text/css" media="all" href="/assets/fonts/1406-fonts.css">

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35072506-1']);
    _gaq.push(['_trackPageview']);
    
    (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();
 </script>

  <script src="/assets/js/app.js"></script>

</head>
  <body>

    <div class="navigation">
  <a href="/">Blog</a>
  <a href="/art">Art</a>
  <a href="/projects">Projects</a>
  <a href="/about">About</a>
</div>
    <div class="content">
      <div id="doc">
        
          <topic class="small">
            Python y la Streaming API de Twitter <span class="extra-topic"></span>
            <div class="ddate">07.06.2014</div>
          </topic>
        
        <p>Me he apuntado al curso online <a href="https://www.coursera.org/course/datasci">Introduction to Data Science</a> de
Coursera y me ha gustado mucho
el ejercicio sobre el análisis semántico de tweets.
En esta entrada solo hablaré sobre cómo bajar tweets de
la <a href="https://dev.twitter.com/">API de Twitter</a>, quizá más adelante hable sobre el
análisis semántico.</p>

<p>Bien, la API de Twitter tiene muchas cosas interesantes,
puedes buscar tweets, usuarios, hashtags; puedes hasta publicarlos
y quien sabe qué demonios más (no me he leído toda la documentación).
También tiene ese que llaman la <a href="https://dev.twitter.com/docs/api/streaming">Streaming API</a>, que es como abrir
el grifo de Twitter: puedes descargar tweets en tiempo real.
Se puede usar cualquier lenguaje para conectarte. Yo usaré
Python, porque estoy fuertemente enganchado a él.</p>

<h4 id="autenticacin">Autenticación</h4>
<p>La API de Twitter es <em>gratis</em>, pero debes pedir permiso. Twitter usa <a href="http://oauth.net/">OAuth</a>
para proveer acceso autorizado a su API.
Lo primero que hay que hacer es obtener los <em>tokens de acceso</em> desde
<a href="https://apps.twitter.com/app/new">la consola</a> y eligir  <em>Create New App</em>.
Sigue los pasos y listo ya tienes tus tókens.
Twitter tiene algunas librerías para tratar con
OAuth, pero en esta ocasión tiraré de Python plano porque
lo único que Twitter requiere es que se añada
la cabecera <code class="highlighter-rouge">Authorization</code> a cada petición que se envíe especificando
los tókens necesarios. Algo así:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">api_key</span> <span class="o">=</span> <span class="s">'TU_API_KEY'</span>
<span class="n">api_secret</span> <span class="o">=</span> <span class="s">'TU_API_SECRET'</span>
<span class="n">access_token_key</span> <span class="o">=</span> <span class="s">'TU_ACCESS_TOKEN_KEY'</span>
<span class="n">access_token_secret</span> <span class="o">=</span> <span class="s">'TU_ACCESS_TOKEN_SECRET'</span>

<span class="n">oauth_token</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">access_token_key</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="n">access_token_secret</span><span class="p">)</span>
<span class="n">oauth_consumer</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">Consumer</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="n">api_secret</span><span class="p">)</span>
<span class="n">signature_method_hmac_sha1</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">SignatureMethod_HMAC_SHA1</span><span class="p">()</span>

<span class="n">http_handler</span>  <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">HTTPHandler</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">https_handler</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">HTTPSHandler</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span></code></pre></figure>

<p>Algo de terminología. En el mundo OAuth, los tókens (el <em>access token</em> y
la parte secreta) son usados en lugar de los usuales usuario y
contraseña. Las <em>consumer credentials</em> son la forma en la que
Twitter tiene de identificar tu aplicación.
HMAC-SHA1 es el método que soporta Twitter para generar la firma.
El resto es la inicialización de los handlers para HTTP.
Ahora solo queda construir la petición y autenticarla con OAuth.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">build_req</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
  <span class="n">req</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">from_consumer_and_token</span><span class="p">(</span>
    <span class="n">oauth_consumer</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">oauth_token</span><span class="p">,</span> <span class="n">http_method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">http_url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
  <span class="n">req</span><span class="o">.</span><span class="n">sign_request</span><span class="p">(</span><span class="n">signature_method_hmac_sha1</span><span class="p">,</span> <span class="n">oauth_consumer</span><span class="p">,</span> <span class="n">oauth_token</span><span class="p">)</span>

  <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">OpenerDirector</span><span class="p">()</span>
  <span class="n">opener</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">http_handler</span><span class="p">)</span>
  <span class="n">opener</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">https_handler</span><span class="p">)</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">to_url</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">response</span></code></pre></figure>

<p>La petición se crea añadiendo las credenciales y firmándola
con HMAC-SHA1.</p>

<h4 id="leyendo-tweets">Leyendo tweets</h4>
<p>La API devuelve una muestra aleatoria
de tweets en formato JSON. Solo hay que imprimir tweet a tweet:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fetch</span><span class="p">():</span>
  <span class="n">url</span> <span class="o">=</span> <span class="s">"https://stream.twitter.com/1/statuses/sample.json"</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">build_req</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">,</span> <span class="p">[])</span>
  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
     <span class="k">print</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></code></pre></figure>

<p>El código en <a href="https://github.com/enrmarc/twitter-api-python">GitHub</a>.</p>


      </div>
    </div>

    <toc-topic>
  <a class="toc" href="mailto:enrmarc@gmail.com">Contact</a>&nbsp;&nbsp;
  <span class="bottom-p">·</span>&nbsp;&nbsp;<a class="toc" href="https://github.com/enrmarc">GitHub</a>&nbsp;&nbsp;
  <!--span class="bottom-p">·</span>&nbsp;&nbsp;<a class="toc" href=""><span class="bottom-l">the</span> wut?</a-->
  </toc-topic>
<div class="paramedics"></div>

    
  </body>
</html>