<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Web Services Axis2 y Android| enrmarc</title>
        <meta name="author" content="enrmarc">
        <link type="image/x-icon" rel="icon" href="http://enrmarc.github.com/img/favicon.ico"/>
        <link rel="stylesheet" href="../css/normalize.css">
        <link rel="stylesheet" href="../css/style.css">
        <script type="text/javascript" src="../css/google-code-prettify/prettify.js"></script>
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-35072506-1']);
            _gaq.push(['_trackPageview']);
          
            (function() {
             var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
             ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
             var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
             })();
         </script>
     </head>
     
     <body onload="prettyPrint()">
         <div id="container">
             <!-- Header -->
             <div id="header">enrmarc</div>
             
             <!-- Navigation -->
             <div id="navigation">
                 <ul>
                     <li><a href="../index.html">home</a></li>
                     <li><a href="../tags.html">tags</a></li>
                     <li><a href="../projects.html">proyectos</a></li>
                     <li><a href="../about.html">sobre mí</a></li>
                 </ul>
             </div>
             
             <!-- Content -->
             <div id="body">
                 <div class="entry-header">
                     <p class="entry-posted">
                     <a class="posted-month">Mar</a>
                     <a class="posted-date">12</a>
                     <a class="posted-year">2012</a>
                     </p>
                     <h1 class="title">Web Services con Apache Axis2 y Android</h1>
                 </div>

                 <div class="entry-content">
                     <h2>Servidor</h2>
                     <p>(Es necesario tener instalado y configurado <a href="http://tomcat.apache.org/">Apache Tomcat</a> y 
                     <a href="http://axis.apache.org/axis2/java/core/">Axis2</a>)</p>
                     <p>La manera más rápida de desplegar un servicio web en Axis2 es creando un <a href="http://axis.apache.org/axis2/java/core/docs/pojoguide.html">POJO</a> (
                     Plain Old Java Object). El POJO utilizado representará a una persona:</p>
                     <pre class="prettyprint">
package org.entidades;

public class Persona {

    private String nombre;
    private int edad;
    private double peso;

    public Persona() {}

    public Persona(String nombre, int edad, double peso) {
        this.nombre = nombre;
        this.edad = edad;
        this.peso = peso;
    }

    public void setNombre(String nombre) { this.nombre = nombre;}

    public void setEdad(int edad) { this.edad = edad;}

    public void setPeso(double peso) { this.peso = peso;}

    public String getNombre() { return nombre;}

    public int getEdad() { return edad;}

    public double getPeso() { return peso;}
}
</pre>
                     <p>Y la clase que represente el servicio web es</p>
<pre class="prettyprint">
package org;

import org.entidades.Persona;

public class Service {

    public Persona test(Persona persona) {
        return new Persona(persona.getNombre(), persona.getEdad(), persona.getPeso());
    }
}</pre>
                     <p>La estructura de directorios en el servidor es:</p>
<pre class="prettyprint">
objetos/
├── META-INF
│   └── services.xml
└── src
    └── org
        ├── entidades
        │   └── Persona.java
        └── Service.java
</pre>
                    <h2>Cliente</h2>
                    <p>El código Android utiliza la librería <a href="http://code.google.com/p/ksoap2-android/">Ksoap2</a> para poder gestionar los mensajes SOAP. Si se quiere
                    enviar un objeto complejo mediante Ksoap2 es necesario implementar la interfaz KvmSerializable:</p>
<pre class="prettyprint">
package com.objetos;

import org.ksoap2.serialization.KvmSerializable;
import org.ksoap2.serialization.PropertyInfo;

import java.util.Hashtable;

public class Persona implements KvmSerializable {

    private String nombre;
    private int edad;
    private double peso;

    public Persona() {}

    public Persona(String nombre, int edad, double peso) {
        this.nombre = nombre;
        this.edad = edad;
        this.peso = peso;
    }

    public void setNombre(String nombre) { this.nombre = nombre;}

    public void setEdad(int edad) { this.edad = edad;}

    public void setPeso(double peso) { this.peso = peso;}

    public String getNombre() { return nombre;}

    public int getEdad() { return edad;}

    public double getPeso() { return peso;}

    /* Ksoap */
    public Object getProperty(int arg0) {
        switch (arg0) {
            case 0: return nombre;
            case 1: return edad;
            case 2: return peso;
        }
        return null;
    }

    public int getPropertyCount() { return 3;}

    public void getPropertyInfo(int index, Hashtable arg1,
            PropertyInfo propertyInfo) {
        switch (index) {
            case 0:
                propertyInfo.name = "nombre";
                propertyInfo.type = PropertyInfo.STRING_CLASS;
                break;
            case 1:
                propertyInfo.name = "edad";
                propertyInfo.type = PropertyInfo.INTEGER_CLASS;
                break;
            case 2:
                propertyInfo.name = "peso";
                propertyInfo.type = Double.class;
                break;
            default:
                break;
        }
    }

    public void setProperty(int index, Object value) {
        switch (index) {
            case 0:
                this.nombre = value.toString();
                break;
            case 1:
                this.edad = Integer.parseInt(value.toString());
                break;
            case 2:
                this.peso = Double.parseDouble(value.toString());
                break;
            default:
                break;
        }
    }
}
</pre>
                    <p>Además para argumentos de tipo double es necesario implementar la interfaz Marshal</p>
<pre class="prettyprint">
package com.objetos;

import java.io.IOException;

import org.ksoap2.serialization.Marshal;
import org.ksoap2.serialization.PropertyInfo;
import org.ksoap2.serialization.SoapSerializationEnvelope;
import org.xmlpull.v1.XmlPullParser;
import org.xmlpull.v1.XmlPullParserException;
import org.xmlpull.v1.XmlSerializer;

public class MarshalDouble implements Marshal {

    public Object readInstance(XmlPullParser parser, String namespace, String name,
            PropertyInfo expected) throws IOException, XmlPullParserException {
        return Double.parseDouble(parser.nextText());
    }

    public void register(SoapSerializationEnvelope cm) {
        cm.addMapping(cm.xsd, "double", Double.class, this);
    }

    public void writeInstance(XmlSerializer writer, Object obj) throws IOException {
        writer.text(obj.toString());
    }
}
</pre>

                    <p>Por último la Activity:</p>
<pre class="prettyprint">
package com.objetos;

import org.ksoap2.SoapEnvelope;
import org.ksoap2.serialization.SoapObject;
import org.ksoap2.serialization.SoapPrimitive;
import org.ksoap2.serialization.SoapSerializationEnvelope;
import org.ksoap2.transport.HttpTransportSE;
import org.ksoap2.transport.HttpTransportSE;
import org.ksoap2.serialization.PropertyInfo;
import org.ksoap2.SoapFault;

import android.app.Activity;
import android.os.Bundle;
import android.os.AsyncTask;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.TextView;
import android.widget.EditText;
import android.widget.Button;
import android.app.ProgressDialog;

public class Main extends Activity {

    private String NAMESPACE = "http://org";
    private String TARGET_NAMESPACE = "http://entidades.org/xsd";
    private String URL = "http://10.0.2.2:8080/axis2/services/objetos/";
    private String METHOD_NAME = "test";
    private Button send;
    private EditText etNombre, etEdad, etPeso;
    private TextView tvNombre, tvEdad, tvPeso;
    
    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main);
        etNombre = (EditText)findViewById(R.id.etNombre);
        etEdad = (EditText)findViewById(R.id.etEdad);
        etPeso = (EditText)findViewById(R.id.etPeso);

        tvNombre = (TextView)findViewById(R.id.tvNombre);
        tvEdad = (TextView)findViewById(R.id.tvEdad);
        tvPeso = (TextView)findViewById(R.id.tvPeso);

        send = (Button)findViewById(R.id.send);
        send.setOnClickListener(new OnClickListener() {
            public void onClick(View view) {
                new Test().execute(
                    new Persona(
                        etNombre.getText().toString(),
                        Integer.parseInt(etEdad.getText().toString()),
                        Double.parseDouble(etPeso.getText().toString())));
            }
        });
    }

    private class Test extends AsyncTask<Persona, Void, Persona> {
        private ProgressDialog dialog = new ProgressDialog(Main.this);
        protected void onPreExecute() {
            dialog.setMessage("Enviando ...");
            dialog.show();
        }

        protected Persona doInBackground(Persona... args) {
            return enviar(args[0]);
        }

        protected void onPostExecute(Persona persona) {
            if (dialog.isShowing()) {
                dialog.dismiss();
            }

            if (persona != null) {
                tvNombre.setText(persona.getNombre());
                tvEdad.setText(Integer.toString(persona.getEdad()));
                tvPeso.setText(Double.toString(persona.getPeso()));
            }
        }
    }

    private Persona enviar(Persona p) {
        HttpTransportSE transport = new HttpTransportSE(URL);
        SoapObject request = new SoapObject(NAMESPACE, METHOD_NAME);
        request.addProperty(p.getClass().getSimpleName(), p);
        SoapSerializationEnvelope envelope = 
            new SoapSerializationEnvelope(SoapEnvelope.VER11);
        envelope.dotNet = true;
        envelope.setOutputSoapObject(request);
        envelope.addMapping(TARGET_NAMESPACE, p.getClass().getSimpleName(),
                p.getClass());
        MarshalDouble md = new MarshalDouble();
        md.register(envelope);

        try {
            transport.call(NAMESPACE + METHOD_NAME, envelope);
            Persona persona = (Persona)envelope.getResponse();
            return persona;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }
}
</pre>
                 </div>
                 
                 <!-- -->
                 <br/>
                 <div class="previous">
                     <a href="../projects/tms.html">&larr; Turing Machine Simulator</a>
                 </div>
                 <div class="next"></div>
             </div>
             
             <!-- Footer -->
             <div id="footer">
                 <p>&copy; Copyright 2012 enrmarc</p>
                 <p class="social">Contacto</p>
                 <ul class="social">
                     <li><a class="social github" href="http://github.com/enrmarc"></a></li>
                     <li><a class="social stackoverflow" href="http://stackoverflow.com/users/434171/enrmarc"></a></li>
                     <li><a class="social twitter" href="http://twitter.com/enrmarc"></a></li>
                     <li><a class="social grooveshark" href="http://grooveshark.com/#!/enrmarc"></a></li>
                     <li><a class="social google" href="https://profiles.google.com/101056314044406602016/about"></a></li>
                     <li><a class="social gmail" href="mailto:enrmarc@gmail.com"></a></li>
                 </ul>
             </div>
         </div>
     </body>
</html>
